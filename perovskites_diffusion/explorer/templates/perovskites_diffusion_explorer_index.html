{% extends "home/templates/base/header_footer.html" %}
{% load staticfiles %}

{% block title %} Perovskites Diffusion {% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href='{% static "components/backgrid/lib/backgrid.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/json-human/css/json.human.css" %}' charset="utf-8">
{% endblock extra_css %}

{% block content %}

{% if alert %}
<div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
  {{ alert }}
</div>

{% else %}

<style>
.backgrid .string-cell { text-align: center; }
.backgrid tbody tr:hover { background-color: #f9f9f9; }
.jh-root:hover { cursor: default; }
</style>

<div class="container">
    <div class="row">
        <h2>{{ title }}</h2>
        <div class="col-md-6">
            {{ provenance|safe }}
        </div>
        <div class="col-md-6">
            <h4>Abbreviations</h4>
            <p>Scroll down for more table columns; Click to show/hide.</p>
            <div style="height:450px; overflow-y:scroll;" id="abbrevs">
                {{ abbreviations|safe }}
            </div>
        </div>
    </div>
    <div class = "row">
        <div id= "graph">
        </div>
    </div>
    <div class="row">
        <h3>Data</h3>
        {{ table|safe }}
    </div>
</div>



<script>
requirejs(['config'], function() {
    require(["backgrid"], function() {
        $(document).ready(function() {
            $("div#abbrevs").on("click", "div > table > tbody > tr", function() {
                var column = $("> th", this).text();
                $("."+column).toggleClass("renderable");
                console.log(column);
            });
        });
    });
});
</script>

<script>

function isUpperCase(c){
    return (c >= 'A') && (c <= 'Z')
}

function findASite(comp){
    var aSite = comp.substring(0,comp.length-4);
        if (isUpperCase(aSite.charAt(aSite.length -1))){
            aSite= aSite.substring(0,aSite.length-1);
        }
                
        else{
             aSite = aSite.substring(0,aSite.length-2);
        }
        return aSite;
}

requirejs(['config'], function() {
    require(["plotly"], function(Plotly) {
        $(document).ready(function(){
            var xVals = []; var yVals = []; var names = [];
            for (t = 0; t < window.tables.length; t++) {
                var table = window.tables[t];
                for (i = 0; i < table['rows'].length; i++) {
                    var row = table['rows'][i];
                    xVals.push(row['opband']);
                    yVals.push(row['emig']);
                    names.push(row['composition'])
                }
            }
            var graph = document.getElementById('graph');
            var layout = {
                margin: {t: 0},
                xaxis: {title: 'O p-band center energy(eV)'},
                yaxis: {title: 'Migration Barrier(eV)'}
            };
            var data = [];
            Plotly.newPlot(graph, [data], layout);
            
            var labels = []; var xTraces = []; var yTraces= [];
            while( names[0] != null){
                var aSite = findASite(names[0]);
                
                //make temporary lists
                var tempLabel = [];
                var tempX = [];
                var tempY = [];
                
                //put first element in the lists
                tempLabel.push(names[0]);
                tempX.push(xVals[0]);
                tempY.push(yVals[0]);
                
                //delete said element from the parent lists
                names.splice(0,1);
                xVals.splice(0,1);
                yVals.splice(0,1);
                //go through rest of list looking for matching aSites
                for(var i = 0; i < names.length; i++){
                    if( findASite(names[i]) == aSite ){
                        //push into temp lists
                        tempLabel.push(names[i]);
                        tempX.push(xVals[i]);
                        tempY.push(yVals[i]);
                        
                        //delete said element from the parent lists
                        names.splice(i,1);
                        xVals.splice(i,1);
                        yVals.splice(i,1);
                        
                        //decrement i so as to not skip values
                        i--;
                     }
                 }
                    
                    labels.push(tempLabel);
                    xTraces.push(tempX);
                    yTraces.push(tempY);

            }
            
            for (var i = 0; i < labels.length; i++){
                var aSite = findASite(labels[i][0]);
                
                var data = [ {
                x : xTraces[i],
                y : yTraces[i],
                text : labels[i],
                marker: {size: 10},
                mode: 'markers',
                name: aSite + "XO3",
                type: 'scatter'
                }];
               Plotly.addTraces(graph, data);
            }
        });
    });
});
</script>

{% endif %}
{% endblock %}
